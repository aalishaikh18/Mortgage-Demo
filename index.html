<!DOCTYPE html>
<html lang="en">
<!-- Previous head and style sections remain the same -->
<head>
    <!-- Previous head content remains the same -->
    <style>
        /* All previous styles remain the same */
    </style>
</head>
<body>
    <!-- Previous HTML structure remains the same -->
    <script>
        const SALESFORCE_INSTANCE = 'https://nfinancial20250116092207779.my.salesforce.com';
        const ACCESS_TOKEN = '00Da3000002CKpr!AQEAQPv6AvVjkingkDsXjb3tdvH1HqBwFB4Sm_Ezzi2OW6U8U6UGFpbJ2EDYYE9Kvl2SW7Jnvt1eGxp4VSt86qB4UNK4xr.h';
        
        // In-memory variable to store the current loan ID
        let currentLoanId = null;
        let pollingInterval = null;

        function updateProgressBar(status) {
            try {
                const steps = document.querySelectorAll('.progress-step');
                const statusIndex = Array.from(document.getElementById('status').options)
                    .findIndex(option => option.value === status);

                steps.forEach((step, index) => {
                    step.classList.remove('active', 'completed');
                    if (index < statusIndex) {
                        step.classList.add('completed');
                    } else if (index === statusIndex) {
                        step.classList.add('active');
                    }
                });
            } catch (error) {
                console.error('Error updating progress bar:', error);
            }
        }

        function updateStatusDisplay(status) {
            try {
                const statusElement = document.getElementById('currentStatus');
                statusElement.textContent = status;
                
                // Remove all existing status classes
                statusElement.classList.remove(
                    'status-DIP', 
                    'status-FMA', 
                    'status-Verification',
                    'status-Valuation',
                    'status-Offer',
                    'status-Conveyancing',
                    'status-Booked',
                    'status-Complete'
                );
                
                // Add appropriate status class
                switch(status) {
                    case 'Decision in Principle':
                        statusElement.classList.add('status-DIP');
                        break;
                    case 'Full Mortgage Application':
                        statusElement.classList.add('status-FMA');
                        break;
                    case 'Verification & Underwriting':
                        statusElement.classList.add('status-Verification');
                        break;
                    case 'Valuation':
                        statusElement.classList.add('status-Valuation');
                        break;
                    case 'Offer':
                        statusElement.classList.add('status-Offer');
                        break;
                    case 'Conveyancing':
                        statusElement.classList.add('status-Conveyancing');
                        break;
                    case 'Booked':
                        statusElement.classList.add('status-Booked');
                        break;
                    case 'Complete':
                        statusElement.classList.add('status-Complete');
                        break;
                }

                // Update select dropdown and progress bar
                document.getElementById('status').value = status;
                updateProgressBar(status);
            } catch (error) {
                console.error('Error updating status display:', error);
            }
        }

        async function pollLoanStatus(loanId) {
            try {
                const response = await fetch(
                    `${SALESFORCE_INSTANCE}/services/data/v57.0/sobjects/LLC_BI__Loan__c/${loanId}?fields=LLC_BI__Stage__c`,
                    {
                        headers: {
                            'Authorization': `Bearer ${ACCESS_TOKEN}`,
                            'Accept': 'application/json'
                        }
                    }
                );
                const result = await response.json();
                if (result.LLC_BI__Stage__c) {
                    updateStatusDisplay(result.LLC_BI__Stage__c);
                }
                return result.LLC_BI__Stage__c;
            } catch (error) {
                console.error('Error polling status:', error);
            }
        }

        async function createRecords(formData) {
            const compositeRequest = {
                allOrNone: true,
                compositeRequest: [
                    {
                        method: 'POST',
                        url: '/services/data/v57.0/sobjects/Account',
                        referenceId: 'newAccount',
                        body: {
                            Name: formData.name
                        }
                    },
                    {
                        method: 'POST',
                        url: '/services/data/v57.0/sobjects/LLC_BI__Loan__c',
                        referenceId: 'newLoan',
                        body: {
                            Name: formData.name,
                            LLC_BI__Account__c: '@{newAccount.id}',
                            LLC_BI__Product_Line__c: 'Mortgage',
                            LLC_BI__Product_Type__c: 'Residential',
                            Transaction_Type__c: 'Purchase',
                            Salary__c: formData.salary,
                            LLC_BI__Amount__c: formData.amount,
                            Dependants__c: formData.dependants,
                            LLC_BI__Stage__c: 'Decision in Principle'
                        }
                    }
                ]
            };

            try {
                const response = await fetch(`${SALESFORCE_INSTANCE}/services/data/v57.0/composite`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(compositeRequest)
                });

                const result = await response.json();
                
                if (result.compositeResponse.every(resp => resp.httpStatusCode === 201)) {
                    return {
                        success: true,
                        loanId: result.compositeResponse[1].body.id
                    };
                } else {
                    throw new Error('Failed to create records');
                }
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        // Clean up any existing interval when the page loads
        window.addEventListener('load', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });

        document.getElementById('mortgageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = document.querySelector('button[type="submit"]');
            const loader = document.getElementById('loader');
            
            // Disable submit button and show loader
            submitButton.disabled = true;
            loader.style.display = 'block';
            
            const formData = {
                name: document.getElementById('name').value,
                salary: document.getElementById('salary').value,
                amount: document.getElementById('amount').value,
                dependants: document.getElementById('dependants').value
            };

            try {
                const result = await createRecords(formData);
                if (result.success) {
                    currentLoanId = result.loanId; // Store loan ID in memory
                    updateStatusDisplay('Decision in Principle');
                    alert('Application submitted successfully!');
                    
                    // Clear any existing interval before setting a new one
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                    }
                    
                    // Start polling for status updates
                    pollingInterval = setInterval(() => {
                        if (currentLoanId) {
                            pollLoanStatus(currentLoanId);
                        }
                    }, 5000);
                }
            } catch (error) {
                console.error('Error submitting application:', error);
                alert('An error occurred while submitting the application.');
            } finally {
                // Re-enable submit button and hide loader
                submitButton.disabled = false;
                loader.style.display = 'none';
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>
